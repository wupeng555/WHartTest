# 默认配置 - 使用预构建的Docker镜像
# 使用方式: docker-compose up -d
#
# 镜像会从 GitHub Container Registry (ghcr.io) 自动拉取
# 如果需要本地构建镜像（开发环境），请注释掉 image 行，取消注释 build 部分

services:
  # Redis 服务 - Celery的broker和backend
  redis:
    image: docker.m.daocloud.io/library/redis:7-alpine
    container_name: wharttest-redis
    ports:
      - "8911:6379"
    volumes:
      - redis-data:/data
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

  # 后端 Django 服务（包含Celery Worker和Beat）
  backend:
    image: ghcr.io/mgdaaslab/wharttest-backend:latest
    # 如果需要本地构建，注释掉上面的image行，取消注释下面的build部分
    # build:
    #   context: ./WHartTest_Django
    #   dockerfile: Dockerfile
    container_name: wharttest-backend
    # 启动逻辑已移至 Dockerfile 的 ENTRYPOINT 和 supervisord.conf
    ports:
      - "8912:8000"
    volumes:
      - ./data:/app/data
      - backend-static:/app/static
    environment:
      - DATABASE_PATH=/app/data/db.sqlite3
      - MEDIA_ROOT=/app/data/media
      - DJANGO_DEBUG=True
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-change-this-in-production}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      - DJANGO_CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:80
      - DJANGO_ADMIN_USERNAME=${DJANGO_ADMIN_USERNAME:-admin}
      - DJANGO_ADMIN_EMAIL=${DJANGO_ADMIN_EMAIL:-admin@example.com}
      - DJANGO_ADMIN_PASSWORD=${DJANGO_ADMIN_PASSWORD:-admin123456}
      # Celery配置
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # 内部API基础URL - 使用localhost因为在同一容器
      - DJANGO_BASE_URL=http://localhost:8000
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 前端 Vue 服务
  frontend:
    image: ghcr.io/mgdaaslab/wharttest-frontend:latest
    # 如果需要本地构建，注释掉上面的image行，取消注释下面的build部分
    # build:
    #   context: ./WHartTest_Vue
    #   dockerfile: Dockerfile
    container_name: wharttest-frontend
    ports:
      - "8913:80"
    depends_on:
      - backend
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # MCP 服务（独立容器）
  mcp:
    image: ghcr.io/mgdaaslab/wharttest-mcp:latest
    # 如果需要本地构建，注释掉上面的image行，取消注释下面的build部分
    # build:
    #   context: ./WHartTest_MCP
    #   dockerfile: Dockerfile
    container_name: wharttest-mcp
    user: root 
    environment:
      # WHartTest Tools 配置
      - WHARTTEST_BACKEND_URL=${WHARTTEST_BACKEND_URL:-http://backend:8000}
      - WHARTTEST_API_KEY=${WHARTTEST_API_KEY:-}
      # MS MCP API 配置（可选）
      - MS_API_HOST=${MS_API_HOST:-http://ms.example.com}
      - MS_ACCESS_KEY=${MS_ACCESS_KEY:-your_16byte_key1}
      - MS_SECRET_KEY=${MS_SECRET_KEY:-your_16byte_key2}
    ports:
      - "8914:8006"  # WHartTest_tools 服务端口
      - "8915:8007"  # ms_mcp_api 服务端口
    volumes:
      - ./data/playwright-screenshots:/tmp/playwright-output  # 使用本地目录挂载
    depends_on:
      - backend
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Playwright MCP 服务（官方Docker镜像）
  playwright-mcp:
    image: mcr.microsoft.com/playwright/mcp
    container_name: wharttest-playwright-mcp
    user: root  # 以 root 用户运行,确保有权限写入挂载目录
    entrypoint: node
    command: [
      "cli.js",
      "--no-sandbox",
      "--host", "0.0.0.0",
      "--allowed-hosts", "*",
      "--config", "/app/playwright-mcp-config.json"
    ]
    ports:
      - "8916:8931"
    volumes:
      - ./data/playwright-screenshots:/tmp/playwright-output  # 使用本地目录挂载
      - ./WHartTest_MCP/playwright-mcp-config.json:/app/playwright-mcp-config.json:ro  # 挂载配置文件
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8931/mcp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  wharttest-network:
    driver: bridge

volumes:
  backend-static:
  redis-data:
  celery-beat-schedule:
  # db.sqlite3 和 media 改用本地目录挂载，不再需要 named volume
  # playwright-screenshots 改用本地目录挂载，不再需要 named volume