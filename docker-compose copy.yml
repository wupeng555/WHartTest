# 本地构建配置 - 用于开发环境
# 使用方式: docker-compose -f "docker-compose copy.yml" up -d --build
#
# 此配置文件会从本地源代码构建所有镜像，适合开发调试使用
#
# 数据库配置:
# - 默认使用 PostgreSQL（生产环境推荐）
# - 如需使用 SQLite（本地开发），请设置环境变量 DATABASE_TYPE=sqlite 并注释掉 postgres 服务

services:
  # PostgreSQL 数据库服务（生产环境默认启用）
  postgres:
    image: docker.m.daocloud.io/library/postgres:16-alpine
    container_name: wharttest-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-wharttest}
    ports:
      - "8919:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 服务 - Celery的broker和backend
  redis:
    # 当前使用 DaoCloud 镜像加速（国内最稳定的公共镜像源之一）
    # 如果拉取失败，可尝试：
    # - dockerproxy.com/library/redis:7-alpine
    # - docker.1panel.live/library/redis:7-alpine
    # - docker.rainbond.cc/library/redis:7-alpine
    image: docker.m.daocloud.io/library/redis:7-alpine
    container_name: wharttest-redis
    ports:
      - "8911:6379"
    volumes:
      - redis-data:/data
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

  # 后端 Django 服务（包含Celery Worker和Beat）
  backend:
    # 本地构建模式
    build:
      context: ./WHartTest_Django
      dockerfile: Dockerfile
    container_name: wharttest-backend
    # 启动逻辑已移至 Dockerfile 的 ENTRYPOINT 和 supervisord.conf
    ports:
      - "8912:8000"
    volumes:
      - ./data:/app/data
      - backend-static:/app/static
    environment:
      # 数据库配置
      # 默认使用 PostgreSQL（生产环境推荐）
      # 如需使用 SQLite（本地开发），请设置 DATABASE_TYPE=sqlite
      - DATABASE_TYPE=${DATABASE_TYPE:-postgres}
      # SQLite 配置（DATABASE_TYPE=sqlite 时使用）
      - DATABASE_PATH=/app/data/db.sqlite3
      # PostgreSQL 配置（DATABASE_TYPE=postgres 时使用）
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-wharttest}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      # 其他配置
      - MEDIA_ROOT=/app/data/media
      - DJANGO_DEBUG=True
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-change-this-in-production}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      - DJANGO_CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:80
      - DJANGO_ADMIN_USERNAME=${DJANGO_ADMIN_USERNAME:-admin}
      - DJANGO_ADMIN_EMAIL=${DJANGO_ADMIN_EMAIL:-admin@example.com}
      - DJANGO_ADMIN_PASSWORD=${DJANGO_ADMIN_PASSWORD:-admin123456}
      # Celery配置
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # 内部API基础URL - 使用localhost因为在同一容器
      - DJANGO_BASE_URL=http://localhost:8000
      # Qdrant向量数据库
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 前端 Vue 服务
  frontend:
    # 本地构建模式
    build:
      context: ./WHartTest_Vue
      dockerfile: Dockerfile
    container_name: wharttest-frontend
    ports:
      - "8913:80"
    depends_on:
      - backend
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # MCP 服务（独立容器）
  mcp:
    # 本地构建模式
    build:
      context: ./WHartTest_MCP
      dockerfile: Dockerfile
    container_name: wharttest-mcp
    user: root
    environment:
      # WHartTest Tools 配置
      - WHARTTEST_BACKEND_URL=${WHARTTEST_BACKEND_URL:-http://backend:8000}
      # 使用系统自动生成的默认API Key，生产环境请在.env中覆盖
      - WHARTTEST_API_KEY=${WHARTTEST_API_KEY:-wharttest-default-mcp-key-2025}
      # MS MCP API 配置（可选）
      - MS_API_HOST=${MS_API_HOST:-http://ms.example.com}
      - MS_ACCESS_KEY=${MS_ACCESS_KEY:-your_16byte_key1}
      - MS_SECRET_KEY=${MS_SECRET_KEY:-your_16byte_key2}
    ports:
      - "8914:8006" # WHartTest_tools 服务端口
      - "8915:8007" # ms_mcp_api 服务端口
    volumes:
      - ./data/playwright-screenshots:/tmp/playwright-output # 使用本地目录挂载
    depends_on:
      - backend
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8006/')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Playwright MCP 服务（官方Docker镜像）
  playwright-mcp:
    image: mcr.microsoft.com/playwright/mcp
    container_name: wharttest-playwright-mcp
    user: root # 以 root 用户运行,确保有权限写入挂载目录
    entrypoint: node
    command: [ "cli.js", "--no-sandbox", "--host", "0.0.0.0", "--allowed-hosts", "*", "--config", "/app/playwright-mcp-config.json" ]
    ports:
      - "8916:8931"
    volumes:
      - ./data/playwright-screenshots:/tmp/playwright-output # 使用本地目录挂载
      - ./WHartTest_MCP/playwright-mcp-config.json:/app/playwright-mcp-config.json:ro # 挂载配置文件
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8931/mcp" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # BGE 嵌入模型服务 (使用 Ollama)
  bge-m3:
    image: ollama/ollama:latest
    container_name: wharttest-bge-m3
    ports:
      - "8917:11434"
    volumes:
      - bge-m3-data:/root/.ollama
    networks:
      - wharttest-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "ollama", "list" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # 启动后运行: docker exec wharttest-bge-m3 ollama pull bge-m3
    # API 兼容 OpenAI，访问: http://localhost:8917/api/embeddings
    deploy:
      resources:
        limits:
          memory: 4G

  # Qdrant 向量数据库 - 知识库检索
  qdrant:
    image: docker.m.daocloud.io/qdrant/qdrant:latest
    container_name: wharttest-qdrant
    ports:
      - "8918:6333"  # REST API
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - wharttest-network
    restart: unless-stopped

networks:
  wharttest-network:
    driver: bridge

volumes:
  backend-static:
  redis-data:
  postgres-data:
  celery-beat-schedule:
  bge-m3-data:
  qdrant-data:
    # db.sqlite3 和 media 改用本地目录挂载，不再需要 named volume
    # playwright-screenshots 改用本地目录挂载，不再需要 named volume
